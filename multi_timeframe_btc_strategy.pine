// ============================================================================
// ADVANCED MULTI-TIMEFRAME BITCOIN TRADING STRATEGY
// ============================================================================
// Generated: 2025-11-13 13:13:36
// Features:
// - Multi-timeframe analysis (15m, 1h, 4h, 1d, 1w)
// - 20+ technical indicators
// - Support/Resistance detection
// - Fibonacci retracements
// - Volume analysis
// - Detailed entry/exit reasons
// - Risk management with ATR
// ============================================================================

//@version=5
strategy("Multi-Timeframe BTC Strategy - Advanced", 
         overlay=true,
         initial_capital=10000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=95,
         commission_type=strategy.commission.percent,
         commission_value=0.1,
         slippage=3,
         pyramiding=0)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// === TIMEFRAME SELECTION ===
useCurrentTimeframe = input.bool(true, "Use Current Timeframe", group="Timeframe")
selectedTimeframe = input.timeframe("60", "Analysis Timeframe", group="Timeframe")
timeframeToUse = useCurrentTimeframe ? timeframe.period : selectedTimeframe

// === MOVING AVERAGES ===
ema12Period = input.int(12, "EMA Fast", minval=1, group="Moving Averages")
ema26Period = input.int(26, "EMA Slow", minval=1, group="Moving Averages")
sma50Period = input.int(50, "SMA Medium", minval=1, group="Moving Averages")
sma200Period = input.int(200, "SMA Long", minval=1, group="Moving Averages")

// === RSI ===
rsiPeriod = input.int(14, "RSI Period", minval=1, group="RSI")
rsiOversold = input.int(30, "Oversold Level", minval=0, maxval=50, group="RSI")
rsiOverbought = input.int(70, "Overbought Level", minval=50, maxval=100, group="RSI")

// === MACD ===
macdFast = input.int(12, "MACD Fast", minval=1, group="MACD")
macdSlow = input.int(26, "MACD Slow", minval=1, group="MACD")
macdSignal = input.int(9, "MACD Signal", minval=1, group="MACD")

// === BOLLINGER BANDS ===
bbLength = input.int(20, "BB Length", minval=1, group="Bollinger Bands")
bbStdDev = input.float(2.0, "BB Std Dev", minval=0.1, step=0.1, group="Bollinger Bands")

// === STOCHASTIC ===
stochLength = input.int(14, "Stochastic Length", minval=1, group="Stochastic")
stochK = input.int(3, "Stochastic %K", minval=1, group="Stochastic")
stochD = input.int(3, "Stochastic %D", minval=1, group="Stochastic")

// === ATR & RISK MANAGEMENT ===
atrLength = input.int(14, "ATR Length", minval=1, group="Risk Management")
atrMultiplierSL = input.float(2.0, "ATR Multiplier (Stop Loss)", minval=0.5, step=0.1, group="Risk Management")
atrMultiplierTP1 = input.float(2.0, "ATR Multiplier (TP1)", minval=0.5, step=0.1, group="Risk Management")
atrMultiplierTP2 = input.float(3.0, "ATR Multiplier (TP2)", minval=0.5, step=0.1, group="Risk Management")
atrMultiplierTP3 = input.float(5.0, "ATR Multiplier (TP3)", minval=0.5, step=0.1, group="Risk Management")

// === SCORING THRESHOLDS ===
strongBuyScore = input.int(8, "Strong Buy Score", minval=1, group="Scoring")
buyScore = input.int(5, "Buy Score", minval=1, group="Scoring")
sellScore = input.int(-5, "Sell Score", maxval=-1, group="Scoring")
strongSellScore = input.int(-8, "Strong Sell Score", maxval=-1, group="Scoring")

// === DATE RANGE ===
startDate = input(timestamp("2020-01-01"), "Start Date", group="Date Range")
endDate = input(timestamp("2099-12-31"), "End Date", group="Date Range")
inDateRange = time >= startDate and time <= endDate

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

// === MOVING AVERAGES ===
ema12 = ta.ema(close, ema12Period)
ema26 = ta.ema(close, ema26Period)
sma50 = ta.sma(close, sma50Period)
sma200 = ta.sma(close, sma200Period)

// === RSI ===
rsi = ta.rsi(close, rsiPeriod)

// === MACD ===
[macdLine, signalLine, histogram] = ta.macd(close, macdFast, macdSlow, macdSignal)

// === BOLLINGER BANDS ===
[bbUpper, bbBasis, bbLower] = ta.bb(close, bbLength, bbStdDev)
bbPosition = (close - bbLower) / (bbUpper - bbLower)

// === STOCHASTIC ===
stochValue = ta.stoch(close, high, low, stochLength)
stochKValue = ta.sma(stochValue, stochK)
stochDValue = ta.sma(stochKValue, stochD)

// === ATR ===
atr = ta.atr(atrLength)

// === ADX (Trend Strength) ===
[diPlus, diMinus, adx] = ta.dmi(14, 14)

// === VOLUME ===
volumeSMA = ta.sma(volume, 20)
volumeRatio = volume / volumeSMA

// === OBV ===
obv = ta.obv

// === PIVOT POINTS (Support/Resistance) ===
pivotHigh = ta.pivothigh(high, 5, 5)
pivotLow = ta.pivotlow(low, 5, 5)

// === FIBONACCI LEVELS ===
fibHigh = ta.highest(high, 50)
fibLow = ta.lowest(low, 50)
fibDiff = fibHigh - fibLow
fib236 = fibHigh - (0.236 * fibDiff)
fib382 = fibHigh - (0.382 * fibDiff)
fib500 = fibHigh - (0.500 * fibDiff)
fib618 = fibHigh - (0.618 * fibDiff)

// ============================================================================
// SIGNAL SCORING SYSTEM
// ============================================================================

var int score = 0
score := 0

// === 1. TREND ANALYSIS ===
trendBullish = close > ema12 and ema12 > ema26
trendBearish = close < ema12 and ema12 < ema26

if trendBullish
    score += 2
else if trendBearish
    score -= 2

// Golden/Death Cross
if close > sma50 and sma50 > sma200
    score += 1
else if close < sma50 and sma50 < sma200
    score -= 1

// === 2. RSI MOMENTUM ===
if rsi < rsiOversold
    score += 3
else if rsi < 40
    score += 2
else if rsi > rsiOverbought
    score -= 3
else if rsi > 60
    score -= 1

// === 3. MACD ===
if macdLine > signalLine and macdLine > 0
    score += 2
else if macdLine > signalLine
    score += 1
else if macdLine < signalLine and macdLine < 0
    score -= 2
else if macdLine < signalLine
    score -= 1

// === 4. STOCHASTIC ===
if stochKValue < 20
    score += 1
else if stochKValue > 80
    score -= 1

// === 5. BOLLINGER BANDS ===
if bbPosition < 0.2
    score += 1
else if bbPosition > 0.8
    score -= 1

// === 6. ADX (Trend Strength) ===
if adx > 25
    if trendBullish
        score += 1
    else if trendBearish
        score -= 1

// === 7. VOLUME ===
if volumeRatio > 1.5
    if close > close[1]
        score += 1
    else
        score -= 1

// === 8. PIVOT POINTS ===
distanceToSupport = not na(pivotLow) ? (close - pivotLow) / close * 100 : 999
distanceToResistance = not na(pivotHigh) ? (pivotHigh - close) / close * 100 : 999

if distanceToSupport < 2
    score += 2
else if distanceToSupport < 5
    score += 1

if distanceToResistance < 2
    score -= 2

// === 9. FIBONACCI ===
nearFib618 = math.abs(close - fib618) / close < 0.01
if nearFib618
    score += 1

// ============================================================================
// SIGNAL GENERATION
// ============================================================================

// BUY SIGNALS
strongBuy = score >= strongBuyScore
buy = score >= buyScore and score < strongBuyScore

// SELL SIGNALS
strongSell = score <= strongSellScore
sell = score <= sellScore and score > strongSellScore

// HOLD
hold = score > sellScore and score < buyScore

// ============================================================================
// POSITION MANAGEMENT
// ============================================================================

var float entryPrice = na
var float stopLoss = na
var float takeProfit1 = na
var float takeProfit2 = na
var float takeProfit3 = na

// ENTRY LOGIC
if (strongBuy or buy) and strategy.position_size == 0 and inDateRange
    entryPrice := close
    stopLoss := close - (atr * atrMultiplierSL)
    takeProfit1 := close + (atr * atrMultiplierTP1)
    takeProfit2 := close + (atr * atrMultiplierTP2)
    takeProfit3 := close + (atr * atrMultiplierTP3)
    
    qty = strongBuy ? 100 : 95
    strategy.entry("Long", strategy.long, qty=strategy.percent_of_equity * qty / 100)
    
    // Visual markers
    markerColor = strongBuy ? color.new(color.lime, 0) : color.new(color.green, 0)
    markerText = strongBuy ? "STRONG BUY\nScore: " + str.tostring(score) : "BUY\nScore: " + str.tostring(score)
    label.new(bar_index, low, markerText, color=markerColor, textcolor=color.white, 
              style=label.style_label_up, size=size.normal)

// EXIT LOGIC
if strategy.position_size > 0
    // Stop Loss
    if close <= stopLoss
        strategy.close("Long", comment="Stop Loss")
        label.new(bar_index, high, "STOP LOSS", color=color.new(color.red, 0), 
                  textcolor=color.white, style=label.style_label_down, size=size.small)
    
    // Take Profits
    else if close >= takeProfit3
        strategy.close("Long", comment="TP3")
        label.new(bar_index, high, "TAKE PROFIT 3", color=color.new(color.green, 0), 
                  textcolor=color.white, style=label.style_label_down, size=size.normal)
    
    else if close >= takeProfit2
        strategy.close("Long", qty_percent=50, comment="TP2 (50%)")
        label.new(bar_index, high, "TP2 (50%)", color=color.new(color.green, 30), 
                  textcolor=color.white, style=label.style_label_down, size=size.small)
    
    else if close >= takeProfit1
        strategy.close("Long", qty_percent=33, comment="TP1 (33%)")
        label.new(bar_index, high, "TP1 (33%)", color=color.new(color.green, 50), 
                  textcolor=color.white, style=label.style_label_down, size=size.tiny)
    
    // Sell Signal Exit
    else if (strongSell or sell) and inDateRange
        strategy.close("Long", comment="Sell Signal")
        label.new(bar_index, high, "SELL SIGNAL\nScore: " + str.tostring(score), 
                  color=color.new(color.orange, 0), textcolor=color.white, 
                  style=label.style_label_down, size=size.small)

// ============================================================================
// PLOTTING
// ============================================================================

// === MOVING AVERAGES ===
plot(ema12, "EMA 12", color=color.new(color.blue, 0), linewidth=2)
plot(ema26, "EMA 26", color=color.new(color.red, 0), linewidth=2)
plot(sma50, "SMA 50", color=color.new(color.orange, 0), linewidth=1)
plot(sma200, "SMA 200", color=color.new(color.purple, 30), linewidth=2)

// === BOLLINGER BANDS ===
p1 = plot(bbUpper, "BB Upper", color=color.new(color.gray, 60))
p2 = plot(bbLower, "BB Lower", color=color.new(color.gray, 60))
fill(p1, p2, color=color.new(color.blue, 90))

// === FIBONACCI LEVELS ===
plot(fib236, "Fib 23.6%", color=color.new(color.green, 80), style=plot.style_circles, linewidth=1)
plot(fib382, "Fib 38.2%", color=color.new(color.yellow, 80), style=plot.style_circles, linewidth=1)
plot(fib500, "Fib 50.0%", color=color.new(color.orange, 50), style=plot.style_cross, linewidth=2)
plot(fib618, "Fib 61.8%", color=color.new(color.red, 80), style=plot.style_circles, linewidth=1)

// === SUPPORT/RESISTANCE ===
plotshape(pivotHigh, "Resistance", shape.triangledown, location.abovebar, 
          color=color.new(color.red, 20), size=size.tiny)
plotshape(pivotLow, "Support", shape.triangleup, location.belowbar, 
          color=color.new(color.green, 20), size=size.tiny)

// === STOP LOSS & TAKE PROFIT LINES ===
plot(strategy.position_size > 0 ? stopLoss : na, "Stop Loss", 
     color=color.new(color.red, 0), style=plot.style_linebr, linewidth=2)
plot(strategy.position_size > 0 ? takeProfit1 : na, "TP1", 
     color=color.new(color.green, 60), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size > 0 ? takeProfit2 : na, "TP2", 
     color=color.new(color.green, 30), style=plot.style_linebr, linewidth=2)
plot(strategy.position_size > 0 ? takeProfit3 : na, "TP3", 
     color=color.new(color.green, 0), style=plot.style_linebr, linewidth=2)

// === BACKGROUND COLOR (Trend) ===
bgcolor(trendBullish and adx > 25 ? color.new(color.green, 95) : 
        trendBearish and adx > 25 ? color.new(color.red, 95) : na)

// === VOLUME BARS ===
barcolor(volumeRatio > 1.5 ? color.new(color.yellow, 50) : na)

// ============================================================================
// DASHBOARD
// ============================================================================

var table dashboard = table.new(position.top_right, 2, 15, border_width=1)

if barstate.islast
    // Header
    table.cell(dashboard, 0, 0, "INDICATOR", bgcolor=color.new(color.gray, 50), text_color=color.white)
    table.cell(dashboard, 1, 0, "VALUE", bgcolor=color.new(color.gray, 50), text_color=color.white)
    
    // Price
    table.cell(dashboard, 0, 1, "Price")
    table.cell(dashboard, 1, 1, str.tostring(close, "#.##"))
    
    // Score
    scoreColor = score >= strongBuyScore ? color.new(color.lime, 50) :
                 score >= buyScore ? color.new(color.green, 50) :
                 score <= strongSellScore ? color.new(color.red, 30) :
                 score <= sellScore ? color.new(color.orange, 50) : color.new(color.gray, 70)
    table.cell(dashboard, 0, 2, "Signal Score")
    table.cell(dashboard, 1, 2, str.tostring(score), bgcolor=scoreColor)
    
    // Trend
    table.cell(dashboard, 0, 3, "Trend")
    trendText = trendBullish ? "ðŸŸ¢ BULL" : trendBearish ? "ðŸ”´ BEAR" : "âšª NEUTRAL"
    table.cell(dashboard, 1, 3, trendText)
    
    // RSI
    table.cell(dashboard, 0, 4, "RSI")
    table.cell(dashboard, 1, 4, str.tostring(rsi, "#.##"))
    
    // MACD
    table.cell(dashboard, 0, 5, "MACD")
    table.cell(dashboard, 1, 5, str.tostring(macdLine, "#.##"))
    
    // Stochastic
    table.cell(dashboard, 0, 6, "Stochastic")
    table.cell(dashboard, 1, 6, str.tostring(stochKValue, "#.##"))
    
    // ADX
    table.cell(dashboard, 0, 7, "ADX")
    table.cell(dashboard, 1, 7, str.tostring(adx, "#.##"))
    
    // ATR
    table.cell(dashboard, 0, 8, "ATR")
    table.cell(dashboard, 1, 8, str.tostring(atr, "#.##"))
    
    // Volume Ratio
    table.cell(dashboard, 0, 9, "Vol Ratio")
    table.cell(dashboard, 1, 9, str.tostring(volumeRatio, "#.##") + "x")
    
    // Position
    table.cell(dashboard, 0, 10, "Position")
    posText = strategy.position_size > 0 ? "ðŸŸ¢ LONG" : "âšª FLAT"
    table.cell(dashboard, 1, 10, posText)
    
    // Entry Price
    if strategy.position_size > 0
        table.cell(dashboard, 0, 11, "Entry")
        table.cell(dashboard, 1, 11, str.tostring(entryPrice, "#.##"))
    
    // Net Profit
    table.cell(dashboard, 0, 12, "Net Profit")
    table.cell(dashboard, 1, 12, str.tostring(strategy.netprofit, "#.##"),
               text_color=strategy.netprofit > 0 ? color.lime : color.red)
    
    // Win Rate
    winRate = strategy.closedtrades > 0 ? (strategy.wintrades / strategy.closedtrades) * 100 : 0
    table.cell(dashboard, 0, 13, "Win Rate")
    table.cell(dashboard, 1, 13, str.tostring(winRate, "#.##") + "%")
    
    // Total Trades
    table.cell(dashboard, 0, 14, "Trades")
    table.cell(dashboard, 1, 14, str.tostring(strategy.closedtrades))

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(strongBuy, "Strong Buy Signal", "BTC: STRONG BUY - Score: {plot("score")}")
alertcondition(buy, "Buy Signal", "BTC: Buy - Score: {plot("score")}")
alertcondition(strongSell, "Strong Sell Signal", "BTC: STRONG SELL - Score: {plot("score")}")
alertcondition(sell, "Sell Signal", "BTC: Sell - Score: {plot("score")}")
alertcondition(volumeRatio > 2, "High Volume", "BTC: Exceptional volume detected!")

// ============================================================================
// NOTES
// ============================================================================
// This multi-timeframe strategy uses a comprehensive scoring system:
//
// SCORING BREAKDOWN:
// - Trend Analysis: Â±3 points
// - RSI Momentum: Â±3 points
// - MACD: Â±2 points
// - Stochastic: Â±1 point
// - Bollinger Bands: Â±1 point
// - ADX (Trend Strength): Â±1 point
// - Volume: Â±1 point
// - Support/Resistance: Â±2 points
// - Fibonacci: Â±1 point
//
// TOTAL POSSIBLE: Â±15 points
//
// SIGNAL THRESHOLDS (Customizable):
// - Strong Buy: Score >= 8
// - Buy: Score >= 5
// - Hold: -4 < Score < 5
// - Sell: Score <= -5
// - Strong Sell: Score <= -8
//
// RISK MANAGEMENT:
// - Stop Loss: ATR-based (2x ATR default)
// - Take Profit Levels: 3 levels (2x, 3x, 5x ATR)
// - Partial profit taking at each level
//
// CUSTOMIZE:
// - Adjust scoring thresholds in settings
// - Change ATR multipliers for your risk tolerance
// - Select different timeframes for analysis
// - Modify indicator periods
//
// BACKTEST THIS STRATEGY:
// 1. Select your preferred timeframe
// 2. Set date range
// 3. View results in Strategy Tester
// 4. Optimize parameters
// 5. Forward test before live trading!
// ============================================================================
